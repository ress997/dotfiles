#!/usr/bin/env zsh
 
# macOS + tmux 用
# Help
#	-m : メーター表示
#	-r : remain を表示

if ! [[ "${(L)$( uname -s )}" == darwin ]]; then
	echo "OS X only"
fi

get_percentage() {
	echo "$(pmset -g ps | egrep -o '[0-9]+%' | tr -d %)"
}

is_charging() {
	pmset -g ps | grep -E "Battery Power|charged" >/dev/null 2>&1
	if [ $? -eq 0 ]; then
		return 1
	else
		return 0
	fi
}

get_meter() {
	local percentage=$1
	if is_charging; then
		echo '|⚡︎⚡︎⚡︎⚡︎⚡︎|'
	else
		if [ $percentage -le 20 ]; then
			echo '|█    |'
		elif [ $percentage -gt 20 ] && [ $percentage -le 40 ]; then
			echo '|██   |'
		elif [ $percentage -gt 40 ] && [ $percentage -le 60 ]; then
			echo '|███  |'
		elif [ $percentage -gt 60 ] && [ $percentage -le 80 ]; then
			echo '|████ |'
		elif [ $percentage -gt 80 ] && [ $percentage -le 100 ]; then
			echo '|█████|'
		fi
	fi
}

get_remain() {
	local time_remain="$(pmset -g ps | grep -o '[0-9]\+:[0-9]\+')"
	if [ -z "$time_remain" ]; then
		time_remain="no estimate"
	fi
	echo "$time_remain"
}

display() {
	local percentage=$1
	local display=$2
	if is_charging; then
		echo -e "#[fg=colour2]${display}#[default]"
	else
		if [ $percentage -lt 20 ]; then
			echo -e "#[fg=red]${display}#[default]"
		else
			echo -e "#[fg=blue]${display}#[default]"
		fi
	fi
}

PERCENTAGE="$(pmset -g ps | egrep -o '[0-9]+%' | tr -d %)"
DISPLAY="${PERCENTAGE}%"

for i in "$@"; do
	case "$i" in
		"-m")
			DISPLAY="${DISPLAY} $(get_meter $PERCENTAGE)"
			;;
		"-r")
			DISPLAY="${DISPLAY} ($(get_remain))"
			;;
	esac
done

display $PERCENTAGE "$DISPLAY"